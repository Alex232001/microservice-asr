name: CI

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: cr.yandex
  REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: "nemo-service"
            path: "nemo-service"
            version: "v1.0.0"
          - name: "whisper-service"
            path: "whisper-service" 
            version: "v1.0.0"

          - name: "vosk-service"
            path: "vosk-service" 
            version: "v1.0.0"

    steps:
    - uses: actions/checkout@v4
    
    - name: Debug - List directories
      run: |
        echo "=== Содержимое репозитория ==="
        ls -la
        echo "=== Проверка существования папки ${{ matrix.path }} ==="
        if [ -d "${{ matrix.path }}" ]; then
          echo "Папка ${{ matrix.path }} существует"
          echo "=== Содержимое папки ${{ matrix.path }} ==="
          ls -la "${{ matrix.path }}"
        else
          echo "Папка ${{ matrix.path }} не существует"
        fi
    
    - name: Build Docker image
      run: |
        echo "Building service: ${{ matrix.name }}"
        echo "Path: ${{ matrix.path }}"
        
        # Проверяем существование папки и Dockerfile
        if [ ! -d "${{ matrix.path }}" ]; then
          echo "Directory ${{ matrix.path }} not found"
          exit 1
        fi
        
        cd "${{ matrix.path }}"
        echo "Текущая директория: $(pwd)"
        echo "Содержимое:"
        ls -la
        
        if [ ! -f "Dockerfile" ]; then
          echo "Dockerfile not found in ${{ matrix.path }}"
          exit 1
        fi
        
        docker build -t ${{ matrix.name }} .
        
    - name: Login to YCR with JSON Key
      run: |
        echo '${{ secrets.YC_JSON_KEY }}' | docker login \
          --username json_key \
          --password-stdin cr.yandex
        
    - name: Tag and push Docker image
      run: |
        docker tag ${{ matrix.name }} $REGISTRY/$REGISTRY_ID/${{ matrix.name }}:${{ matrix.version }}
        docker tag ${{ matrix.name }} $REGISTRY/$REGISTRY_ID/${{ matrix.name }}:latest
        
        docker push $REGISTRY/$REGISTRY_ID/${{ matrix.name }}:${{ matrix.version }}
        docker push $REGISTRY/$REGISTRY_ID/${{ matrix.name }}:latest
        
    - name: Analyze image size
      run: |
        echo "=== АНАЛИЗ РАЗМЕРА DOCKER ОБРАЗА ==="
        echo "Сервис: ${{ matrix.name }}"
        
        # Получаем общий размер образа
        SIZE_BYTES=$(docker image inspect ${{ matrix.name }}:latest --format='{{.Size}}')
        SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1024 / 1024" | bc -l)
        
        echo "Размер образа ${{ matrix.name }}: $SIZE_MB MB"
        echo ""

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to server
      run: |
        echo "Деплой всех сервисов завершен успешно!"
        echo "Собраны и загружены в registry:"
        echo "- whisper-service:v1.0.0"
        echo "- vosk-service:v1.0.0"
