name: CI

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: cr.yandex
  REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: "nemo-service"
            path: "nemo-service"
            version: "v1.0.0"
          - name: "vosk-service"
            path: "vosk-service" 
            version: "v1.0.0"
          # - name: "future-service"  # раскомментировать при добавлении третьего сервиса
          #   path: "future-service-path"
          #   version: "v1.0.0"

    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        echo "Building service: ${{ matrix.service.name }}"
        cd ${{ matrix.service.path }}
        
        # Проверяем существование Dockerfile
        if [ ! -f "Dockerfile" ]; then
          echo " Dockerfile not found in ${{ matrix.service.path }}"
          exit 1
        fi
        
        docker build -t ${{ matrix.service.name }} .
        
    - name: Login to YCR with JSON Key
      run: |
        echo '${{ secrets.YC_JSON_KEY }}' | docker login \
          --username json_key \
          --password-stdin cr.yandex
        
    - name: Tag and push Docker image
      run: |
        docker tag ${{ matrix.service.name }} $REGISTRY/$REGISTRY_ID/${{ matrix.service.name }}:${{ matrix.service.version }}
        docker tag ${{ matrix.service.name }} $REGISTRY/$REGISTRY_ID/${{ matrix.service.name }}:latest
        
        docker push $REGISTRY/$REGISTRY_ID/${{ matrix.service.name }}:${{ matrix.service.version }}
        docker push $REGISTRY/$REGISTRY_ID/${{ matrix.service.name }}:latest
        
    - name: Analyze image size
      run: |
        echo "=== АНАЛИЗ РАЗМЕРА DOCKER ОБРАЗА ==="
        echo "Сервис: ${{ matrix.service.name }}"
        
        # Получаем общий размер образа
        SIZE_BYTES=$(docker image inspect ${{ matrix.service.name }}:latest --format='{{.Size}}')
        SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1024 / 1024" | bc -l)
        
        echo "Размер образа ${{ matrix.service.name }}: $SIZE_MB MB"
        echo ""

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to server
      run: |
        echo "Деплой всех сервисов завершен успешно!"
        echo "Собраны и загружены в registry:"
        echo "- nemo-asr:${{ env.nemo_version }}"
        echo "- vosk-service:${{ env.vosk_version }}"
        # Добавьте здесь команды для деплоя на ваш сервер